user  nginx;
worker_processes auto;

events { worker_connections 1024; }

http {
  sendfile on;
  resolver 127.0.0.11 ipv6=off valid=30s;
  map $http_upgrade $connection_upgrade { default upgrade; '' close; }
  
  upstream signal_upstream { server signal:5002; }
  upstream user_upstream   { server user:5003; }
  upstream room_upstream   { server room:5004; }
  upstream language_upstream { server language:5005; }


  server {
    listen 80;

    proxy_hide_header Access-Control-Allow-Origin;
    proxy_hide_header Access-Control-Allow-Credentials;
    proxy_hide_header Access-Control-Allow-Headers;
    proxy_hide_header Access-Control-Allow-Methods;
    proxy_hide_header Access-Control-Expose-Headers;

    add_header Access-Control-Allow-Origin "*" always;
    add_header Access-Control-Allow-Methods "GET,POST,PUT,PATCH,DELETE,OPTIONS" always;
    add_header Access-Control-Allow-Headers "$http_access_control_request_headers" always;
    add_header Access-Control-Expose-Headers "Content-Length, Content-Range, X-Request-Id" always;
    add_header Access-Control-Max-Age "86400" always;

    if ($request_method = OPTIONS) { return 204; }

    # ---------- signal ----------
    location ^~ /signal {
      proxy_http_version 1.1;
      proxy_set_header Upgrade           $http_upgrade;
      proxy_set_header Connection        $connection_upgrade;
      proxy_set_header Host              $host;
      proxy_set_header X-Real-IP         $remote_addr;
      proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_buffering off;
      proxy_read_timeout 86400;
      proxy_send_timeout 86400;
      proxy_pass http://signal_upstream;
    }

    # ---------- user ----------
    location ^~ /user {
      proxy_set_header Host              $host;
      proxy_set_header X-Real-IP         $remote_addr;
      proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header Authorization     $http_authorization;
      proxy_read_timeout 180s;
      proxy_connect_timeout 5s;
      proxy_pass http://user_upstream;
    }

    # ---------- room ----------
    location ^~ /room {
      proxy_set_header Host              $host;
      proxy_set_header X-Real-IP         $remote_addr;
      proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header Authorization     $http_authorization;
      proxy_read_timeout 180s;
      proxy_connect_timeout 5s;
      proxy_pass http://room_upstream;
    }

    # ---------- language ----------
    location ^~ /language {
      proxy_set_header Host              $host;
      proxy_set_header X-Real-IP         $remote_addr;
      proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header Authorization     $http_authorization;
      proxy_read_timeout 180s;
      proxy_connect_timeout 5s;
      proxy_pass http://language_upstream;
    }

    location = /healthz { return 200 "ok"; }
  }
}
