user  nginx;
worker_processes auto;

events { worker_connections 1024; }

http {
  sendfile on;

  upstream room_upstream   { server room:5001; }
  upstream signal_upstream { server signal:5002; }

  server {
    listen 80;

    # ---------- rooms ----------
    # Mantém o path /rooms e subpaths (ex.: /rooms, /rooms/)
    location /rooms {
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_pass http://room_upstream;   # sem barra final => mantém /rooms... no upstream
    }

    # ---------- signal ----------
    # Aceita /signal e reescreve internamente para /signals (seu serviço usa /signals)
    location /signal {
      rewrite ^/signal/?(.*)$ /signals/$1 break;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_pass http://signal_upstream; # mantém path reescrito
    }

    # Também aceita /signals direto se preferir
    location /signals {
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_pass http://signal_upstream;
    }

    # Health local
    location = /healthz { return 200 "ok"; }
  }
}
